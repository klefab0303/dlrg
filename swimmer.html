<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mein Bereich â€“ DLRG</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <nav>
    <div class="logo"><span>DLRG</span> Wettkampf-App</div>
    <div class="nav-right">
      <span class="nav-user" id="nav-user"></span>
      <button class="logout-btn" onclick="logout()">Abmelden</button>
    </div>
  </nav>

  <div class="container">
    <div class="tabs">
      <button class="tab-btn" data-tab="tab-training">ğŸŠ Training</button>
      <button class="tab-btn" data-tab="tab-disciplines">ğŸ¯ Disziplinen</button>
      <button class="tab-btn" data-tab="tab-times">â± Zeiten</button>
    </div>

    <div class="tab-content" id="tab-training">
      <div class="card">
        <h2>Trainingsanwesenheit</h2>
        <p style="margin-bottom:1rem; color:var(--text-light); font-size:0.88rem;">
          Gib an, ob du zu den geplanten Trainings kommst.
        </p>
        <div id="training-list"><div class="spinner">LÃ¤dt â€¦</div></div>
      </div>
    </div>

    <div class="tab-content" id="tab-disciplines">
      <div class="card">
        <h2>Meine Disziplinen</h2>
        <p style="margin-bottom:1rem; color:var(--text-light); font-size:0.88rem;">
          Klicke auf eine Disziplin, um die Beschreibung zu sehen.
        </p>
        <div id="disc-list"><div class="spinner">LÃ¤dt â€¦</div></div>
      </div>
    </div>

    <div class="tab-content" id="tab-times">
      <div class="card">
        <h2>Meine Wettkampfzeiten</h2>
        <p style="margin-bottom:1rem; color:var(--text-light); font-size:0.88rem;">
          Format: <strong>mm:ss,hh</strong> (z.B. <code>1:23,45</code>)
        </p>
        <div id="times-list"><div class="spinner">LÃ¤dt â€¦</div></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script src="app.js"></script>
  <script>
    let currentUser = null;
    let swimmerId   = null;

    (async () => {
      currentUser = await checkAuth('schwimmer');
      if (!currentUser) return;

      const { data: swimmer } = await db
        .from('swimmers')
        .select('id, name, year')
        .eq('user_id', currentUser.id)
        .single();

      if (!swimmer) {
        document.body.innerHTML = '<p style="padding:2rem">Kein Schwimmerprofil gefunden. Bitte Trainer kontaktieren.</p>';
        return;
      }
      swimmerId = swimmer.id;
      document.getElementById('nav-user').textContent = swimmer.name + ' (' + swimmer.year + ')';

      initTabs();
      loadTrainings();
      loadDisciplines();
      loadTimes();
    })();

    // â”€â”€â”€ TRAININGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadTrainings() {
      const { data: trainings } = await db
        .from('trainings').select('id, date').order('date', { ascending: true });

      const { data: attendances } = await db
        .from('attendance').select('training_id, status').eq('user_id', currentUser.id);

      const attMap = {};
      (attendances || []).forEach(a => { attMap[a.training_id] = a.status; });

      const container = document.getElementById('training-list');
      if (!trainings || trainings.length === 0) {
        container.innerHTML = '<p style="color:var(--text-light)">Noch keine Trainings eingetragen.</p>';
        return;
      }

      let html = '<table><thead><tr><th>Datum</th><th>Kommst du?</th><th></th></tr></thead><tbody>';
      trainings.forEach(t => {
        const status = attMap[t.id] || '';
        html += `<tr>
          <td>${formatDate(t.date)}</td>
          <td>
            <div class="attendance-radio">
              <label><input type="radio" name="att-${t.id}" value="ja" ${status === 'ja' ? 'checked' : ''}> Ja</label>
              <label><input type="radio" name="att-${t.id}" value="nein" ${status === 'nein' ? 'checked' : ''}> Nein</label>
            </div>
          </td>
          <td><button class="btn btn-sm btn-secondary" onclick="saveAttendance('${t.id}')">Speichern</button></td>
        </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    async function saveAttendance(trainingId) {
      const selected = document.querySelector(`input[name="att-${trainingId}"]:checked`);
      if (!selected) { alert('Bitte Ja oder Nein auswÃ¤hlen.'); return; }

      await db.from('attendance').upsert({
        user_id: currentUser.id, training_id: trainingId, status: selected.value
      }, { onConflict: 'user_id,training_id' });

      const btn = event.target;
      btn.textContent = 'âœ“';
      setTimeout(() => { btn.textContent = 'Speichern'; }, 2000);
    }

    // â”€â”€â”€ DISZIPLINEN (mit Beschreibung + Typ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadDisciplines() {
      const { data } = await db
        .from('swimmer_disciplines')
        .select('discipline_id, disciplines(name, type, description, team_size)')
        .eq('swimmer_id', swimmerId);

      const container = document.getElementById('disc-list');
      if (!data || data.length === 0) {
        container.innerHTML = '<p style="color:var(--text-light)">Keine Disziplinen zugewiesen.</p>';
        return;
      }

      let html = '';
      data.forEach((d, i) => {
        const disc = d.disciplines;
        const typeBadge = disc.type === 'mannschaft'
          ? '<span class="badge-mannschaft">Mannschaft (4er)</span>'
          : '<span class="badge-einzel">Einzel</span>';
        const desc = disc.description || 'Keine Beschreibung vorhanden.';

        html += `
        <div class="disc-item">
          <div class="disc-item-header" onclick="toggleDisc(this)">
            <span class="disc-name">${disc.name}</span>
            <span class="disc-meta">${typeBadge} <span class="disc-arrow">â–¶</span></span>
          </div>
          <div class="disc-item-body">${desc}</div>
        </div>`;
      });
      container.innerHTML = html;
    }

    function toggleDisc(header) {
      header.classList.toggle('open');
      header.nextElementSibling.classList.toggle('open');
    }

    // â”€â”€â”€ ZEITEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadTimes() {
      const { data: myDiscs } = await db
        .from('swimmer_disciplines')
        .select('discipline_id, disciplines(name, type)')
        .eq('swimmer_id', swimmerId);

      const { data: times } = await db
        .from('times').select('discipline_id, time').eq('user_id', currentUser.id);

      const timeMap = {};
      (times || []).forEach(t => { timeMap[t.discipline_id] = t.time; });

      const container = document.getElementById('times-list');
      if (!myDiscs || myDiscs.length === 0) {
        container.innerHTML = '<p style="color:var(--text-light)">Keine Disziplinen zugewiesen.</p>';
        return;
      }

      let html = '<table><thead><tr><th>Disziplin</th><th>Typ</th><th>Zeit</th><th></th></tr></thead><tbody>';
      myDiscs.forEach(d => {
        const disc = d.disciplines;
        const current = timeMap[d.discipline_id];
        const typeBadge = disc.type === 'mannschaft'
          ? '<span class="badge-mannschaft">Team</span>'
          : '<span class="badge-einzel">Einzel</span>';

        html += `<tr>
          <td>${disc.name}</td>
          <td>${typeBadge}</td>
          <td><input type="text" id="time-${d.discipline_id}" placeholder="1:23,45"
            value="${current != null ? formatTime(current) : ''}"
            style="width:110px; padding:6px 10px; border:1.5px solid var(--border); border-radius:6px; font-size:0.9rem;"></td>
          <td><button class="btn btn-sm btn-secondary" onclick="saveTime('${d.discipline_id}')">Speichern</button></td>
        </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    async function saveTime(disciplineId) {
      const input = document.getElementById('time-' + disciplineId);
      const val = input.value.trim();
      if (!val) { alert('Bitte eine Zeit eingeben.'); return; }
      const seconds = parseTime(val);
      if (seconds === null) { alert('Format: mm:ss,hh (z.B. 1:23,45)'); return; }

      const { error } = await db.from('times').upsert({
        user_id: currentUser.id, discipline_id: disciplineId, time: seconds
      }, { onConflict: 'user_id,discipline_id' });

      const btn = event.target;
      btn.textContent = error ? 'âœ—' : 'âœ“';
      setTimeout(() => { btn.textContent = 'Speichern'; }, 2500);
    }
  </script>
</body>
</html>
