<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Schwimmer – Wettkampfschwimmen</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Mein Dashboard</h1>
    <nav>
      <span id="userName"></span>
      <button onclick="logout()">Abmelden</button>
    </nav>
  </header>

  <main>
    <div class="tabs">
      <button class="tab active" onclick="switchTab(this,'tab-training')">Training</button>
      <button class="tab" onclick="switchTab(this,'tab-einzel')">Einzeldisziplinen</button>
      <button class="tab" onclick="switchTab(this,'tab-staffel')">Staffeln</button>
    </div>

    <section id="tab-training" class="tab-content active">
      <h2>Meine Trainingseinheiten</h2>
      <div id="trainingList"></div>
    </section>

    <section id="tab-einzel" class="tab-content">
      <h2>Einzeldisziplinen</h2>
      <div id="einzelList"></div>
    </section>

    <section id="tab-staffel" class="tab-content">
      <h2>Staffeln</h2>
      <div id="staffelList"></div>
    </section>
  </main>

  <script src="supabase.js"></script>
  <script src="app.js"></script>
  <script>
    checkAuth('schwimmer');

    async function loadMyTrainings() {
      const user = (await db.auth.getUser()).data.user;
      const { data: swimmer } = await db.from('swimmers').select('id').eq('user_id', user.id).single();
      if (!swimmer) return;

      const { data: assigned } = await db.from('training_swimmers').select('training_id').eq('swimmer_id', swimmer.id);
      const ids = (assigned || []).map(a => a.training_id);
      if (!ids.length) { document.getElementById('trainingList').innerHTML = '<p class="empty">Keine Einheiten zugeteilt.</p>'; return; }

      const { data: trainings } = await db.from('trainings').select('*').in('id', ids).order('date', { ascending: true });
      const { data: att } = await db.from('attendance').select('*').eq('user_id', user.id);

      const container = document.getElementById('trainingList');
      container.innerHTML = '';

      (trainings || []).forEach(t => {
        const time = formatTimeRange(t.start_time, t.end_time);
        const a = (att || []).find(x => x.training_id === t.id);
        const status = a ? a.status : null;

        container.innerHTML += `
          <div class="card">
            <div class="card-row">
              <div>
                <strong>${t.date}</strong>
                ${time ? `<span class="time-badge">${time}</span>` : ''}
              </div>
              <div class="att-buttons">
                <button class="btn btn-small ${status === 'ja' ? 'btn-active-yes' : ''}"
                  onclick="setAttendance('${t.id}','ja')">Zusagen</button>
                <button class="btn btn-small ${status === 'nein' ? 'btn-active-no' : ''}"
                  onclick="setAttendance('${t.id}','nein')">Absagen</button>
              </div>
            </div>
          </div>`;
      });
    }

    async function setAttendance(trainingId, status) {
      const user = (await db.auth.getUser()).data.user;
      const { data: existing } = await db.from('attendance').select('id').eq('training_id', trainingId).eq('user_id', user.id).single();
      if (existing) {
        await db.from('attendance').update({ status }).eq('id', existing.id);
      } else {
        await db.from('attendance').insert({ training_id: trainingId, user_id: user.id, status });
      }
      loadMyTrainings();
    }

    async function loadMyEinzel() {
      const user = (await db.auth.getUser()).data.user;
      const { data: swimmer } = await db.from('swimmers').select('id').eq('user_id', user.id).single();
      if (!swimmer) return;

      const { data: discs } = await db.from('disciplines').select('*').eq('type', 'einzel').order('name');
      const { data: sd } = await db.from('swimmer_disciplines').select('*').eq('swimmer_id', swimmer.id);
      const { data: times } = await db.from('times').select('*').eq('swimmer_id', swimmer.id);

      const container = document.getElementById('einzelList');
      container.innerHTML = '';

      const myDiscs = (discs || []).filter(d => (sd || []).some(x => x.discipline_id === d.id));
      if (!myDiscs.length) { container.innerHTML = '<p class="empty">Keine Disziplinen zugewiesen.</p>'; return; }

      myDiscs.forEach(d => {
        const t = (times || []).find(x => x.discipline_id === d.id);
        const desc = d.description ? `<p class="disc-desc">${d.description}</p>` : '';
        container.innerHTML += `
          <div class="card">
            <div class="card-header" onclick="toggleCard(this)">
              <strong>${d.name}</strong>
              ${t ? `<span class="time-badge">${t.time_value}</span>` : ''}
            </div>
            <div class="card-body" style="display:none">
              ${desc}
            </div>
          </div>`;
      });
    }

    async function loadMyStaffel() {
      const user = (await db.auth.getUser()).data.user;
      const { data: swimmer } = await db.from('swimmers').select('id').eq('user_id', user.id).single();
      if (!swimmer) return;

      const { data: discs } = await db.from('disciplines').select('*').eq('type', 'mannschaft').order('name');
      const { data: positions } = await db.from('relay_positions').select('*');
      const { data: swimmers } = await db.from('swimmers').select('id, first_name, last_name');
      const { data: times } = await db.from('times').select('*');

      const container = document.getElementById('staffelList');
      container.innerHTML = '';

      const myStaffeln = (discs || []).filter(d => (positions || []).some(p => p.discipline_id === d.id && p.swimmer_id === swimmer.id));
      if (!myStaffeln.length) { container.innerHTML = '<p class="empty">Keiner Staffel zugeteilt.</p>'; return; }

      myStaffeln.forEach(d => {
        const desc = d.description ? `<p class="disc-desc">${d.description}</p>` : '';
        let posRows = '';
        for (let p = 1; p <= 4; p++) {
          const pos = (positions || []).find(x => x.discipline_id === d.id && x.position === p);
          const s = pos ? (swimmers || []).find(x => x.id === pos.swimmer_id) : null;
          const t = pos ? (times || []).find(x => x.discipline_id === d.id && x.swimmer_id === pos.swimmer_id) : null;
          const isMe = pos && pos.swimmer_id === swimmer.id;
          posRows += `
            <tr class="${isMe ? 'highlight-me' : ''}">
              <td class="pos-num">${p}.</td>
              <td>${s ? `${s.first_name} ${s.last_name}` : '–'}</td>
              <td>${t ? t.time_value : '–'}</td>
            </tr>`;
        }
        container.innerHTML += `
          <div class="card">
            <div class="card-header" onclick="toggleCard(this)">
              <strong>${d.name}</strong>
              <span class="badge badge-staffel">Staffel</span>
            </div>
            <div class="card-body" style="display:none">
              ${desc}
              <table class="assign-table relay-table">
                <thead><tr><th></th><th>Schwimmer</th><th>Zeit</th></tr></thead>
                <tbody>${posRows}</tbody>
              </table>
            </div>
          </div>`;
      });
    }

    function toggleCard(header) {
      const body = header.nextElementSibling;
      body.style.display = body.style.display === 'none' ? 'block' : 'none';
    }

    function formatTimeRange(s, e) {
      if (!s) return '';
      const fmt = t => t.substring(0, 5);
      return e ? `${fmt(s)} – ${fmt(e)}` : fmt(s);
    }

    loadMyTrainings();
    loadMyEinzel();
    loadMyStaffel();
  </script>
</body>
</html>
