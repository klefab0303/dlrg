<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trainer-Dashboard â€“ DLRG</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <nav>
    <div class="logo"><span>DLRG</span> Trainer-Dashboard</div>
    <div class="nav-right">
      <span class="nav-user">Trainer</span>
      <button class="logout-btn" onclick="logout()">Abmelden</button>
    </div>
  </nav>

  <div class="container">
    <div class="stats-row">
      <div class="stat-card"><div class="stat-num" id="stat-swimmers">â€“</div><div class="stat-label">Schwimmer</div></div>
      <div class="stat-card"><div class="stat-num" id="stat-trainings">â€“</div><div class="stat-label">Trainings</div></div>
      <div class="stat-card"><div class="stat-num" id="stat-disciplines">â€“</div><div class="stat-label">Disziplinen</div></div>
    </div>

    <div class="tabs">
      <button class="tab-btn" data-tab="tab-attendance">ğŸ“‹ Anwesenheit</button>
      <button class="tab-btn" data-tab="tab-times">â± Zeiten</button>
      <button class="tab-btn" data-tab="tab-disciplines">ğŸ¯ Disziplinen</button>
      <button class="tab-btn" data-tab="tab-accounts">ğŸ‘¤ Konten</button>
    </div>

    <!-- ANWESENHEIT -->
    <div class="tab-content" id="tab-attendance">
      <div class="card">
        <h2>AnwesenheitsÃ¼bersicht</h2>
        <div class="form-group" style="max-width:280px; margin-bottom:1rem">
          <label for="select-training">Training auswÃ¤hlen</label>
          <select id="select-training" onchange="loadAttendanceOverview()">
            <option value="">â€“ bitte wÃ¤hlen â€“</option>
          </select>
        </div>
        <div id="attendance-overview"></div>
      </div>
    </div>

    <!-- ZEITEN -->
    <div class="tab-content" id="tab-times">
      <div class="card">
        <h2>Alle Wettkampfzeiten</h2>
        <div class="form-group" style="max-width:280px; margin-bottom:1rem">
          <label for="select-swimmer-times">Schwimmer auswÃ¤hlen</label>
          <select id="select-swimmer-times" onchange="loadTimesForSwimmer()">
            <option value="">â€“ bitte wÃ¤hlen â€“</option>
          </select>
        </div>
        <div id="times-overview"></div>
      </div>
    </div>

    <!-- DISZIPLINEN-ÃœBERSICHT -->
    <div class="tab-content" id="tab-disciplines">
      <div class="card">
        <h2>Alle Disziplinen</h2>
        <p style="margin-bottom:1rem; color:var(--text-light); font-size:0.88rem;">
          Klicke auf eine Disziplin, um die Beschreibung zu sehen.
        </p>
        <div id="all-disc-list"><div class="spinner">LÃ¤dt â€¦</div></div>
      </div>
    </div>

    <!-- KONTEN -->
    <div class="tab-content" id="tab-accounts">
      <div class="card">
        <h2>Schwimmerkonten verwalten</h2>
        <div id="accounts-list"><div class="spinner">LÃ¤dt â€¦</div></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script src="app.js"></script>
  <script>
    let allSwimmers = [];

    (async () => {
      const user = await checkAuth('trainer');
      if (!user) return;
      initTabs();
      await Promise.all([loadStats(), loadTrainingSelect(), loadSwimmerSelect(), loadAllDisciplines()]);
      loadAccounts();
    })();

    // â”€â”€â”€ STATISTIKEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadStats() {
      const [sw, tr, di] = await Promise.all([
        db.from('swimmers').select('id', { count: 'exact', head: true }),
        db.from('trainings').select('id', { count: 'exact', head: true }),
        db.from('disciplines').select('id', { count: 'exact', head: true }),
      ]);
      document.getElementById('stat-swimmers').textContent   = sw.count ?? 'â€“';
      document.getElementById('stat-trainings').textContent  = tr.count ?? 'â€“';
      document.getElementById('stat-disciplines').textContent = di.count ?? 'â€“';
    }

    // â”€â”€â”€ DROPDOWNS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadTrainingSelect() {
      const { data } = await db.from('trainings').select('id, date').order('date', { ascending: true });
      const sel = document.getElementById('select-training');
      (data || []).forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = formatDate(t.date);
        sel.appendChild(opt);
      });
    }

    async function loadSwimmerSelect() {
      const { data } = await db.from('swimmers').select('id, name, year, user_id').order('name');
      allSwimmers = data || [];
      const sel = document.getElementById('select-swimmer-times');
      allSwimmers.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name + ' (' + s.year + ')';
        sel.appendChild(opt);
      });
    }

    // â”€â”€â”€ ANWESENHEIT (FIX: separate Abfragen statt fehlerhaftem Join) â”€â”€â”€
    async function loadAttendanceOverview() {
      const trainingId = document.getElementById('select-training').value;
      const container  = document.getElementById('attendance-overview');
      if (!trainingId) { container.innerHTML = ''; return; }
      container.innerHTML = '<div class="spinner">LÃ¤dt â€¦</div>';

      // Alle Schwimmer und alle Anwesenheiten separat laden
      const [attRes, swRes] = await Promise.all([
        db.from('attendance').select('user_id, status').eq('training_id', trainingId),
        db.from('swimmers').select('id, name, year, user_id').order('name'),
      ]);

      const attMap = {};
      (attRes.data || []).forEach(a => { attMap[a.user_id] = a.status; });

      const swimmers = swRes.data || [];
      let ja = 0, nein = 0, offen = 0;

      let html = '<table><thead><tr><th>Schwimmer</th><th>Jahrgang</th><th>Status</th></tr></thead><tbody>';
      swimmers.forEach(s => {
        const status = attMap[s.user_id];
        let badge;
        if (status === 'ja')        { badge = '<span class="badge-ja">Ja</span>'; ja++; }
        else if (status === 'nein') { badge = '<span class="badge-nein">Nein</span>'; nein++; }
        else                        { badge = '<span style="color:var(--text-light); font-size:0.8rem">â€“</span>'; offen++; }
        html += `<tr><td>${s.name}</td><td>${s.year}</td><td>${badge}</td></tr>`;
      });
      html += '</tbody></table>';
      html += `<p style="margin-top:0.8rem; font-size:0.82rem; color:var(--text-light)">
        âœ… Ja: <strong>${ja}</strong> &nbsp;|&nbsp; âŒ Nein: <strong>${nein}</strong> &nbsp;|&nbsp; â³ Offen: <strong>${offen}</strong></p>`;
      container.innerHTML = html;
    }

    // â”€â”€â”€ ZEITEN FÃœR SCHWIMMER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadTimesForSwimmer() {
      const swimmerId = document.getElementById('select-swimmer-times').value;
      const container = document.getElementById('times-overview');
      if (!swimmerId) { container.innerHTML = ''; return; }
      container.innerHTML = '<div class="spinner">LÃ¤dt â€¦</div>';

      const swimmer = allSwimmers.find(s => s.id === swimmerId);
      if (!swimmer || !swimmer.user_id) { container.innerHTML = '<p>Fehler.</p>'; return; }

      const [discRes, timesRes] = await Promise.all([
        db.from('swimmer_disciplines').select('discipline_id, disciplines(id, name, type)').eq('swimmer_id', swimmerId),
        db.from('times').select('discipline_id, time').eq('user_id', swimmer.user_id),
      ]);

      const timeMap = {};
      (timesRes.data || []).forEach(t => { timeMap[t.discipline_id] = t.time; });

      const discs = discRes.data || [];
      if (discs.length === 0) {
        container.innerHTML = '<p style="color:var(--text-light)">Keine Disziplinen zugewiesen.</p>';
        return;
      }

      let html = '<table><thead><tr><th>Disziplin</th><th>Typ</th><th>Zeit</th><th></th></tr></thead><tbody>';
      discs.forEach(d => {
        const disc = d.disciplines;
        const t = timeMap[disc.id];
        const typeBadge = disc.type === 'mannschaft'
          ? '<span class="badge-mannschaft">Team</span>'
          : '<span class="badge-einzel">Einzel</span>';

        html += `<tr>
          <td>${disc.name}</td>
          <td>${typeBadge}</td>
          <td><input type="text" id="trainer-time-${disc.id}"
            value="${t != null ? formatTime(t) : ''}" placeholder="1:23,45"
            style="width:110px; padding:6px 10px; border:1.5px solid var(--border); border-radius:6px; font-size:0.9rem;"></td>
          <td><button class="btn btn-sm btn-secondary"
            onclick="saveTimeTrainer('${swimmerId}','${disc.id}')">Speichern</button></td>
        </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    async function saveTimeTrainer(swimmerId, disciplineId) {
      const swimmer = allSwimmers.find(s => s.id === swimmerId);
      if (!swimmer?.user_id) { alert('Schwimmer nicht gefunden.'); return; }

      const input = document.getElementById('trainer-time-' + disciplineId);
      const val = input.value.trim();
      if (!val) { alert('Bitte Zeit eingeben.'); return; }
      const seconds = parseTime(val);
      if (seconds === null) { alert('Format: mm:ss,hh'); return; }

      const { error } = await db.from('times').upsert({
        user_id: swimmer.user_id, discipline_id: disciplineId, time: seconds
      }, { onConflict: 'user_id,discipline_id' });

      const btn = event.target;
      btn.textContent = error ? 'âœ—' : 'âœ“';
      setTimeout(() => { btn.textContent = 'Speichern'; }, 2500);
    }

    // â”€â”€â”€ ALLE DISZIPLINEN (mit Beschreibung) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadAllDisciplines() {
      const { data } = await db.from('disciplines').select('*').order('type').order('name');
      const container = document.getElementById('all-disc-list');
      if (!data || data.length === 0) {
        container.innerHTML = '<p style="color:var(--text-light)">Keine Disziplinen vorhanden.</p>';
        return;
      }

      let html = '';
      data.forEach(disc => {
        const typeBadge = disc.type === 'mannschaft'
          ? '<span class="badge-mannschaft">Mannschaft (' + (disc.team_size || 4) + 'er)</span>'
          : '<span class="badge-einzel">Einzel</span>';
        const desc = disc.description || 'Keine Beschreibung vorhanden.';

        html += `
        <div class="disc-item">
          <div class="disc-item-header" onclick="toggleDisc(this)">
            <span class="disc-name">${disc.name}</span>
            <span class="disc-meta">${typeBadge} <span class="disc-arrow">â–¶</span></span>
          </div>
          <div class="disc-item-body">${desc}</div>
        </div>`;
      });
      container.innerHTML = html;
    }

    function toggleDisc(header) {
      header.classList.toggle('open');
      header.nextElementSibling.classList.toggle('open');
    }

    // â”€â”€â”€ KONTEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadAccounts() {
      const { data: swimmers } = await db.from('swimmers').select('id, name, year, user_id').order('name');
      const userIds = (swimmers || []).map(s => s.user_id).filter(Boolean);
      const { data: usersData } = await db.from('users').select('id, active').in('id', userIds);

      const activeMap = {};
      (usersData || []).forEach(u => { activeMap[u.id] = u.active; });

      const container = document.getElementById('accounts-list');
      if (!swimmers || swimmers.length === 0) {
        container.innerHTML = '<p style="color:var(--text-light)">Keine Schwimmer.</p>';
        return;
      }

      let html = '<table><thead><tr><th>Name</th><th>Jahrgang</th><th>Status</th><th>Aktion</th></tr></thead><tbody>';
      swimmers.forEach(s => {
        const isActive = activeMap[s.user_id] !== false;
        const badge = isActive ? '<span class="badge-aktiv">Aktiv</span>' : '<span class="badge-inaktiv">Inaktiv</span>';
        const btnLabel = isActive ? 'Deaktivieren' : 'Aktivieren';
        const btnClass = isActive ? 'btn-danger' : 'btn-success';
        html += `<tr>
          <td>${s.name}</td><td>${s.year}</td><td>${badge}</td>
          <td><button class="btn btn-sm ${btnClass}" onclick="toggleAccount('${s.user_id}', ${isActive})">${btnLabel}</button></td>
        </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    async function toggleAccount(userId, currentlyActive) {
      if (!confirm(currentlyActive ? 'Konto deaktivieren?' : 'Konto aktivieren?')) return;
      await db.from('users').update({ active: !currentlyActive }).eq('id', userId);
      loadAccounts();
    }
  </script>
</body>
</html>
