<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trainer – Wettkampfschwimmen</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Trainer-Dashboard</h1>
    <nav>
      <span id="userName"></span>
      <button onclick="logout()">Abmelden</button>
    </nav>
  </header>

  <main>
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab(this,'tab-training')">Training</button>
      <button class="tab" onclick="switchTab(this,'tab-einzel')">Einzeldisziplinen</button>
      <button class="tab" onclick="switchTab(this,'tab-staffel')">Staffeln</button>
    </div>

    <!-- ===================== TRAINING ===================== -->
    <section id="tab-training" class="tab-content active">
      <h2>Trainingseinheiten</h2>
      <div class="card">
        <h3>Neue Einheit erstellen</h3>
        <div class="form-row">
          <label>Datum<input type="date" id="tDate"></label>
          <label>Von<input type="time" id="tStart"></label>
          <label>Bis<input type="time" id="tEnd"></label>
        </div>
        <button class="btn" onclick="createTraining()">Erstellen</button>
      </div>

      <div id="trainingList"></div>
    </section>

    <!-- ===================== EINZEL ===================== -->
    <section id="tab-einzel" class="tab-content">
      <h2>Einzeldisziplinen</h2>
      <div id="einzelList"></div>
    </section>

    <!-- ===================== STAFFEL ===================== -->
    <section id="tab-staffel" class="tab-content">
      <h2>Staffeln</h2>
      <div id="staffelList"></div>
    </section>
  </main>

  <script src="supabase.js"></script>
  <script src="app.js"></script>
  <script>
    checkAuth('trainer');

    /* ---------- Training ---------- */
    async function createTraining() {
      const date = document.getElementById('tDate').value;
      const start = document.getElementById('tStart').value;
      const end = document.getElementById('tEnd').value;
      if (!date) return alert('Bitte Datum angeben.');
      const { error } = await db.from('trainings').insert({
        date, start_time: start || null, end_time: end || null
      });
      if (error) return alert(error.message);
      loadTrainings();
    }

    async function loadTrainings() {
      const { data: trainings } = await db.from('trainings').select('*').order('date', { ascending: false });
      const { data: swimmers } = await db.from('swimmers').select('id, first_name, last_name, user_id');
      const { data: assigned } = await db.from('training_swimmers').select('*');
      const { data: attendance } = await db.from('attendance').select('*');

      const container = document.getElementById('trainingList');
      container.innerHTML = '';

      (trainings || []).forEach(t => {
        const time = formatTimeRange(t.start_time, t.end_time);
        const myAssigned = (assigned || []).filter(a => a.training_id === t.id);
        const myAttendance = (attendance || []).filter(a => a.training_id === t.id);

        let swimmerRows = (swimmers || []).map(s => {
          const isAssigned = myAssigned.some(a => a.swimmer_id === s.id);
          const att = myAttendance.find(a => a.user_id === s.user_id);
          const statusLabel = att ? (att.status === 'ja' ? 'Zugesagt' : att.status === 'nein' ? 'Abgesagt' : 'Offen') : 'Offen';
          const statusClass = att ? att.status : 'offen';
          return `
            <tr>
              <td>
                <label class="check-label">
                  <input type="checkbox" ${isAssigned ? 'checked' : ''}
                    onchange="toggleSwimmerTraining('${t.id}','${s.id}', this.checked)">
                  ${s.first_name} ${s.last_name}
                </label>
              </td>
              <td><span class="status-pill ${statusClass}">${statusLabel}</span></td>
            </tr>`;
        }).join('');

        container.innerHTML += `
          <div class="card">
            <div class="card-header" onclick="toggleCard(this)">
              <strong>${t.date}</strong> ${time ? `<span class="time-badge">${time}</span>` : ''}
            </div>
            <div class="card-body" style="display:none">
              <table class="assign-table">
                <thead><tr><th>Schwimmer</th><th>Status</th></tr></thead>
                <tbody>${swimmerRows}</tbody>
              </table>
              <button class="btn btn-small btn-danger" onclick="deleteTraining('${t.id}')">Einheit loeschen</button>
            </div>
          </div>`;
      });
    }

    async function toggleSwimmerTraining(trainingId, swimmerId, add) {
      if (add) {
        await db.from('training_swimmers').insert({ training_id: trainingId, swimmer_id: swimmerId });
      } else {
        await db.from('training_swimmers').delete().eq('training_id', trainingId).eq('swimmer_id', swimmerId);
      }
    }

    async function deleteTraining(id) {
      if (!confirm('Einheit wirklich loeschen?')) return;
      await db.from('trainings').delete().eq('id', id);
      loadTrainings();
    }

    /* ---------- Einzeldisziplinen ---------- */
    async function loadEinzel() {
      const { data: discs } = await db.from('disciplines').select('*').eq('type', 'einzel').order('name');
      const { data: swimmers } = await db.from('swimmers').select('id, first_name, last_name');
      const { data: sd } = await db.from('swimmer_disciplines').select('*');
      const { data: times } = await db.from('times').select('*');

      const container = document.getElementById('einzelList');
      container.innerHTML = '';

      (discs || []).forEach(d => {
        let rows = (swimmers || []).map(s => {
          const linked = (sd || []).some(x => x.discipline_id === d.id && x.swimmer_id === s.id);
          const t = (times || []).find(x => x.discipline_id === d.id && x.swimmer_id === s.id);
          return `
            <tr>
              <td>
                <label class="check-label">
                  <input type="checkbox" ${linked ? 'checked' : ''}
                    onchange="toggleDisc('${d.id}','${s.id}', this.checked)">
                  ${s.first_name} ${s.last_name}
                </label>
              </td>
              <td>
                <input type="text" class="time-input" placeholder="00:00.00"
                  value="${t ? t.time_value : ''}"
                  onchange="saveTime('${d.id}','${s.id}', this.value)">
              </td>
            </tr>`;
        }).join('');

        const desc = d.description ? `<p class="disc-desc">${d.description}</p>` : '';

        container.innerHTML += `
          <div class="card">
            <div class="card-header" onclick="toggleCard(this)">
              <strong>${d.name}</strong>
            </div>
            <div class="card-body" style="display:none">
              ${desc}
              <table class="assign-table">
                <thead><tr><th>Schwimmer</th><th>Zeit</th></tr></thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          </div>`;
      });
    }

    /* ---------- Staffeln ---------- */
    async function loadStaffel() {
      const { data: discs } = await db.from('disciplines').select('*').eq('type', 'mannschaft').order('name');
      const { data: swimmers } = await db.from('swimmers').select('id, first_name, last_name');
      const { data: positions } = await db.from('relay_positions').select('*');
      const { data: times } = await db.from('times').select('*');

      const container = document.getElementById('staffelList');
      container.innerHTML = '';

      (discs || []).forEach(d => {
        const desc = d.description ? `<p class="disc-desc">${d.description}</p>` : '';
        const opts = (swimmers || []).map(s => `<option value="${s.id}">${s.first_name} ${s.last_name}</option>`).join('');

        let posRows = '';
        for (let p = 1; p <= 4; p++) {
          const pos = (positions || []).find(x => x.discipline_id === d.id && x.position === p);
          const selectedId = pos ? pos.swimmer_id : '';
          const t = pos ? (times || []).find(x => x.discipline_id === d.id && x.swimmer_id === pos.swimmer_id) : null;
          posRows += `
            <tr>
              <td class="pos-num">${p}.</td>
              <td>
                <select class="pos-select" onchange="setRelayPos('${d.id}', ${p}, this.value)">
                  <option value="">– auswählen –</option>
                  ${opts.replace(`value="${selectedId}"`, `value="${selectedId}" selected`)}
                </select>
              </td>
              <td>
                <input type="text" class="time-input" placeholder="00:00.00"
                  value="${t ? t.time_value : ''}"
                  ${selectedId ? `onchange="saveTime('${d.id}','${selectedId}', this.value)"` : 'disabled'}>
              </td>
            </tr>`;
        }

        container.innerHTML += `
          <div class="card">
            <div class="card-header" onclick="toggleCard(this)">
              <strong>${d.name}</strong>
              <span class="badge badge-staffel">Staffel</span>
            </div>
            <div class="card-body" style="display:none">
              ${desc}
              <table class="assign-table relay-table">
                <thead><tr><th></th><th>Schwimmer</th><th>Zeit</th></tr></thead>
                <tbody>${posRows}</tbody>
              </table>
            </div>
          </div>`;
      });
    }

    async function setRelayPos(discId, position, swimmerId) {
      // Alte Position loeschen
      await db.from('relay_positions').delete().eq('discipline_id', discId).eq('position', position);
      if (swimmerId) {
        // Schwimmer evtl. aus anderer Position dieser Disziplin entfernen
        await db.from('relay_positions').delete().eq('discipline_id', discId).eq('swimmer_id', swimmerId);
        await db.from('relay_positions').insert({ discipline_id: discId, swimmer_id: swimmerId, position });
      }
      loadStaffel();
    }

    /* ---------- Shared ---------- */
    async function toggleDisc(discId, swimmerId, add) {
      if (add) {
        await db.from('swimmer_disciplines').insert({ discipline_id: discId, swimmer_id: swimmerId });
      } else {
        await db.from('swimmer_disciplines').delete().eq('discipline_id', discId).eq('swimmer_id', swimmerId);
      }
    }

    async function saveTime(discId, swimmerId, value) {
      if (!value) {
        await db.from('times').delete().eq('discipline_id', discId).eq('swimmer_id', swimmerId);
        return;
      }
      const { data: existing } = await db.from('times').select('id').eq('discipline_id', discId).eq('swimmer_id', swimmerId).single();
      if (existing) {
        await db.from('times').update({ time_value: value }).eq('id', existing.id);
      } else {
        await db.from('times').insert({ discipline_id: discId, swimmer_id: swimmerId, time_value: value });
      }
    }

    function toggleCard(header) {
      const body = header.nextElementSibling;
      body.style.display = body.style.display === 'none' ? 'block' : 'none';
    }

    function formatTimeRange(s, e) {
      if (!s) return '';
      const fmt = t => t.substring(0, 5);
      return e ? `${fmt(s)} – ${fmt(e)}` : fmt(s);
    }

    // Init
    loadTrainings();
    loadEinzel();
    loadStaffel();
  </script>
</body>
</html>
